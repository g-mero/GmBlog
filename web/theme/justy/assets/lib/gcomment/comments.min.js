var gen_comments=function(t){"use strict";const e=864e5;function n(t){let e="";if(document.cookie.length>0){const n=document.cookie.split("; ");for(let o=0;o<n.length;o+=1){const a=n[o].split("=");a[0]===t&&([,e]=a)}}return e}function o(t){!function(t,n,o){let a=new Date;o?"number"==typeof o?a.setTime(a.getTime()+o):a=o:a.setTime(a.getTime()+e);window.document.cookie=`${t}=${n};path=/;expires=${a.toUTCString()}`}(t,"",-1)}new Map,new Map;const a={pas:new URLSearchParams(window.location.search),get:t=>a.pas.get(t),set(t,e){a.pas.set(t,e),(t=>{const e=`${window.location.pathname}?${t}`;window.history.pushState({url:e,title:document.title},document.title,e)})(a.pas.toString())}};return function(e){t.defaults.baseURL="/api/v1/";const i=()=>n("login_token"),r=(t=1004)=>{t>1003&&t<1008&&(o("login_token"),o("avatar_url"),o("nickname"),window.location.reload())},c=t=>{const e={id:t.id,userID:t.user_id,nickname:t.nickname,avatarUrl:t.avatar_url,content:t.content,likes:t.likes,replys:t.replys,isEdited:t.is_edited,createAt:t.created_at,toUserNickname:t.to_user_nickname,toCommentID:t.to_comment_id,children:[]};return e.replys>0&&null!==t.children&&t.children.forEach((t=>{e.children.push(c(t))})),e},s=(o,a,c,s)=>{if(""===i())return void Qmsg.error("登录之后才可以评论哦");if(o.length<3||o.length>200)return void Qmsg.error("评论字数不符合要求");Gcmt.loading(!0);const l={content:o,article_id:e,to_comment_id:Number(a)||0,to_user_id:Number(c)||0};t.post("comment/add",l,{headers:{Authorization:`Bearer ${i()}`}}).then((t=>{if(200===t.data.status){Qmsg.success("评论成功");let e=1;0!==l.to_comment_id&&(e=0===l.to_user_id?2:3);let a=s;void 0===a&&(a=document.createElement("div"));let i="";if(0!==l.to_user_id){const t=a.querySelector("span");null!==t&&(i=t.innerText)}const{data:r}=t.data,c={id:r.id,userID:r.user_id,nickname:n("nickname"),avatarUrl:window.decodeURIComponent(n("avatar_url")),content:o,likes:0,replys:0,isEdited:!1,toUserNickname:i,createAt:r.created_at,toCommentID:l.to_comment_id,children:[]};Gcmt.insertOneComment(c,a,e)}else Qmsg.error(`Error:${t.data.message} -- 你可以尝试刷新`),r(t.data.status)})).catch((()=>{Qmsg.error("请求失败，这可能是服务器或者您的网络问题导致的")})).finally((()=>{Gcmt.loading(!1)}))},l=()=>{const o=Number(a.get("cmt_pn"))||0;let s=!0;""!==i()&&""!==n("avatar_url")&&(s=!1),Gcmt.loading(!0),((n=1,o=!0)=>o?t.get(`comment_limit?article_id=${e}`):t.get(`comment?article_id=${e}&pagenum=${n}`,{headers:{Authorization:`Bearer ${i()}`}}))(o,s).then((t=>{if(200===t.data.status){const e=t.data.data,n=Math.ceil(t.data.total/8);let a=o;(o>n||o<1)&&(a=o>0?n:1),Gcmt.setComments((t=>{const e=[];return null==t||void 0===t.length||t.length<1||t.forEach((t=>{const n=c(t);e.push(n)})),e})(e),t.data.total,n,a)}else Gcmt.setComments(),r(t.data.status),Qmsg.error(`请求出错：${t.data.message}`)})).catch((()=>{Gcmt.setComments()})).finally((()=>{Gcmt.loading(!1)}))};Gcmt.init({onPostBtn:s,avatarTippy:"使用GitHub登录本站",onReplyPostBtn:s,onPagiClick(t){""!==i()?(a.set("cmt_pn",t.toString()),l()):Qmsg.error("登录后才可以查看哦")}}),l(),function(){if(""!==n("avatar_url")&&""!==i())return Gcmt.setAvatar(`<img src="${decodeURIComponent(n("avatar_url"))}" alt="${n("nickname")}">`,`你好，${n("nickname")}`),void Gcmt.setAvatarBtn();window.LoginWithGithubGmero=(t,e)=>{200===t?(Qmsg.success("登录成功，即将刷新"),setTimeout((()=>{window.location.reload()}),2e3)):Qmsg.error(`登录出错:${e}`)},Gcmt.setAvatarBtn((()=>{const t=window.GLOBAL_CONST_GMERO.GITHUB_CLIENT_ID;if(""===t)return void Qmsg.error("没有获取到clientID，可能是服务器没有开启认证功能");const{host:e}=window.location,n=`https://github.com/login/oauth/authorize?client_id=${t}&redirect_url=${`http://${e}/api/v1/oauth/redirect`}&scope=user:email`,o=window.open(n,"gmero-login-github","modal=yes,toolbar=no,titlebar=no,menuba=no,location=no,top=200,left=500,width=600,height=400");Gcmt.loading(!0);const a=setInterval((()=>{o&&o.closed&&(Gcmt.loading(!1),clearInterval(a))}),500);null!==o&&o.focus()}))}()}}(axios);
